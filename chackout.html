<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>E&J Minimarket - Finalizar Compra</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta content="" name="keywords" />
  <meta content="" name="description" />

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet" />

  <!-- Icon Font Stylesheet -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Libraries Stylesheet -->
  <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

  <!-- Customized Bootstrap Stylesheet -->
  <link href="css/bootstrap.min.css" rel="stylesheet" />

  <!-- Template Stylesheet -->
  <link href="css/style.css" rel="stylesheet" />
</head>
<body>
  <!-- Spinner Start -->
  <div id="spinner" class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" role="status"></div>
  </div>
  <!-- Spinner End -->

  <!-- Navbar start -->
  <div class="container-fluid fixed-top">
    <div class="container topbar d-none d-lg-block" style="background-color: rgb(255, 123, 0)">
      <div class="d-flex justify-content-between">
        <div class="top-info ps-2">
          <small class="me-3"><i class="fas fa-map-marker-alt me-2 text-secondary"></i>
            <a id="mapLink" target="_blank" class="text-white">Jr Huancayo 209</a></small>
          <small class="me-3"><i class="fas fa-envelope me-2 text-secondary"></i>
            <a id="gmailLink" target="_blank" class="text-white">info@tiendaeyj.com</a></small>
        </div>
        <div class="top-link pe-2">
          <a href="#" class="text-white"><small class="text-white mx-2">Políticas de privacidad</small>/</a>
          <a href="#" class="text-white"><small class="text-white mx-2">Términos de uso</small>/</a>
          <a href="#" class="text-white"><small class="text-white ms-2">Ventas y reembolsos</small></a>
        </div>
      </div>
    </div>
    <div class="container px-0">
      <nav class="navbar navbar-light bg-white navbar-expand-xl" style="background-color: red">
        <a href="index.html" class="navbar-brand"><h1 class="text-primary display-6" style="color: red">E&J Minimarket</h1></a>
        <button class="navbar-toggler py-2 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
          <span class="fa fa-bars text-primary"></span>
        </button>
        <div class="collapse navbar-collapse bg-white" id="navbarCollapse">
          <div class="navbar-nav mx-auto">
            <a href="index.html" class="nav-item nav-link active">Menú</a>
            <a href="shop.html" class="nav-item nav-link">Tienda</a>
            <a href="shop-detail.html" class="nav-item nav-link">Detalles de tienda</a>
            <div class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Páginas</a>
              <div class="dropdown-menu m-0 bg-secondary rounded-0">
                <a href="cart.html" class="dropdown-item">Carrito</a>
                <a href="chackout.html" class="dropdown-item">Finalizar compra</a>
                <a href="historial.html" class="dropdown-item">Historial de compras</a>
                <a href="testimonial.html" class="dropdown-item">Testimonios</a>
              </div>
            </div>
            <a href="contact.html" class="nav-item nav-link">Contacto</a>
          </div>
          <div class="d-flex m-3 me-0">
            <button class="btn-search btn border border-secondary btn-md-square rounded-circle bg-white me-4" data-bs-toggle="modal" data-bs-target="#searchModal">
              <i class="fas fa-search text-primary"></i>
            </button>
            <a href="cart.html" class="position-relative me-4 my-auto">
              <i class="fa fa-shopping-bag fa-2x"></i>
              <span id="cart-count" class="position-absolute bg-secondary rounded-circle d-flex align-items-center justify-content-center text-dark px-1" style="top: -5px; left: 15px; height: 20px; min-width: 20px">0</span>
            </a>
            <a href="Login.html" class="my-auto">
              <i class="fas fa-user fa-2x"></i>
            </a>
          </div>
        </div>
      </nav>
    </div>
  </div>
  <!-- Navbar End -->

  <!-- Modal Search Start -->
  <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content rounded-0">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Buscar por palabra clave</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex align-items-center">
          <div class="input-group w-75 mx-auto d-flex">
            <input type="search" class="form-control p-3" placeholder="Palabras clave" aria-describedby="search-icon-1" />
            <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Search End -->

  <!-- Single Page Header start -->
  <div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Finalizar compra</h1>
    <ol class="breadcrumb justify-content-center mb-0">
      <li class="breadcrumb-item"><a href="index.html">Menú</a></li>
      <li class="breadcrumb-item"><a href="#">Páginas</a></li>
      <li class="breadcrumb-item active text-white">Finalizar compra</li>
    </ol>
  </div>
  <!-- Single Page Header End -->

  <!-- Checkout Page Start -->
  <div class="container-fluid py-5">
    <div class="container py-5">
      <h1 class="mb-4">Detalles de facturación</h1>
      <form id="checkout-form">
        <div class="row g-5">
          <div class="col-md-12 col-lg-6 col-xl-7">
            <div class="row">
              <div class="col-md-12 col-lg-6">
                <div class="form-item w-100">
                  <label for="nombre" class="form-label my-3">Nombre<sup>*</sup></label>
                  <input type="text" class="form-control" id="nombre" required />
                </div>
              </div>
              <div class="col-md-12 col-lg-6">
                <div class="form-item w-100">
                  <label for="apellidos" class="form-label my-3">Apellidos<sup>*</sup></label>
                  <input type="text" class="form-control" id="apellidos" required />
                </div>
              </div>
            </div>
            <div class="form-item">
              <label class="form-label my-3">Nombre de la empresa (opcional)</label>
              <input type="text" class="form-control" id="empresa" />
            </div>
            <div class="form-item">
              <label class="form-label my-3">País<sup>*</sup></label>
              <input type="text" class="form-control" id="pais" required />
            </div>
            <div class="form-item">
              <label class="form-label my-3">Dirección<sup>*</sup></label>
              <input type="text" class="form-control" id="direccion" placeholder="Número de casa y nombre de la calle" required />
            </div>
            <div class="form-item">
              <label class="form-label my-3">Ciudad<sup>*</sup></label>
              <input type="text" class="form-control" id="ciudad" required />
            </div>
            <div class="form-item">
              <label class="form-label my-3">Código postal<sup>*</sup></label>
              <input type="text" class="form-control" id="codigo_postal" required />
            </div>
            <div class="form-item">
              <label class="form-label my-3">Teléfono móvil<sup>*</sup></label>
              <input type="tel" class="form-control" id="telefono" required />
            </div>
            <div class="form-item">
              <label class="form-label my-3">Correo electrónico<sup>*</sup></label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="form-check my-3">
              <input type="checkbox" class="form-check-input" id="Account-1" name="Accounts" value="Accounts" />
              <label class="form-check-label" for="Account-1">¿Crear una cuenta?</label>
            </div>
            <hr />
            <div class="form-check my-3">
              <input class="form-check-input" type="checkbox" id="Address-1" name="Address" value="Address" />
              <label class="form-check-label" for="Address-1">¿Enviar a una dirección diferente?</label>
            </div>
            <div class="form-item">
              <textarea name="notas" class="form-control" id="notas" spellcheck="false" cols="30" rows="11" placeholder="Notas del pedido (opcional)"></textarea>
            </div>
          </div>
          <div class="col-md-12 col-lg-6 col-xl-5">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Producto</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Precio</th>
                    <th scope="col">Cantidad</th>
                    <th scope="col">Total</th>
                  </tr>
                </thead>
                <tbody id="cart-items">
                  <!-- Los productos del carrito se insertarán aquí dinámicamente -->
                </tbody>
              </table>
            </div>
            <div class="row g-4 text-center align-items-center justify-content-center border-bottom py-3">
              <div class="col-12">
                <div class="form-check text-start my-3">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Transfer-1" name="payment" value="Transferencia bancaria" required />
                  <label class="form-check-label" for="Transfer-1">Transferencia bancaria directa</label>
                </div>
                <p class="text-start text-dark">Realiza tu pago directamente en nuestra cuenta bancaria. Usa el ID de tu pedido como referencia de pago. Tu pedido no será enviado hasta que los fondos se hayan acreditado en nuestra cuenta.</p>
              </div>
            </div>
            <div class="row g-4 text-center align-items-center justify-content-center border-bottom py-3">
              <div class="col-12">
                <div class="form-check text-start my-3">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Payments-1" name="payment" value="Pago con cheque" />
                  <label class="form-check-label" for="Payments-1">Pago con cheque</label>
                </div>
              </div>
            </div>
            <div class="row g-4 text-center align-items-center justify-content-center border-bottom py-3">
              <div class="col-12">
                <div class="form-check text-start my-3">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Delivery-1" name="payment" value="Pago contra entrega" />
                  <label class="form-check-label" for="Delivery-1">Pago contra entrega</label>
                </div>
              </div>
            </div>
            <div class="row g-4 text-center align-items-center justify-content-center border-bottom py-3">
              <div class="col-12">
                <div class="form-check text-start my-3">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Paypal-1" name="payment" value="Paypal" />
                  <label class="form-check-label" for="Paypal-1">Paypal</label>
                </div>
              </div>
            </div>
            <div class="row g-4 text-center align-items-center justify-content-center pt-4">
              <button type="submit" class="btn border-secondary py-3 px-4 text-uppercase w-100 text-primary">Realizar pedido</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- Checkout Page End -->

  <!-- Back to Top -->
  <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i class="fa fa-arrow-up"></i></a>

  <div id="main-content11">
    <!-- Esto es para el pie de página -->
    <!-- Footer End -->
    <!-- Copyright End -->
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/waypoints/waypoints.min.js"></script>
  <script src="lib/lightbox/js/lightbox.min.js"></script>
  <script src="lib/owlcarousel/owl.carousel.min.js"></script>

  <!-- Template Javascript -->
  <script src="js/main.js"></script>
  <script src="js/footer.js"></script>

  <!-- Lógica de Finalizar Compra -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar si el usuario ha iniciado sesión
      let usuario_id = localStorage.getItem('id_usuario');
      if (!usuario_id) {
        alert("Por favor, inicia sesión primero.");
        window.location.href = 'Login.html';
        return;
      }

      // Actualizar el contador del carrito
      const actualizarContadorCarrito = async () => {
        try {
          const response = await fetch(`http://localhost/minemarket/api/obtener_cantidad_carrito.php?usuario_id=${usuario_id}`);
          if (!response.ok) throw new Error('Error en la respuesta de la API');
          const data = await response.json();
          document.getElementById('cart-count').textContent = data.cantidad || '0';
        } catch (error) {
          console.error('Error al actualizar contador:', error);
          document.getElementById('cart-count').textContent = '0';
        }
      };

      // Función para actualizar totales
      const actualizarTotales = (subtotal, costoEnvio) => {
        const tbody = document.getElementById('cart-items');
        const subtotalRow = tbody.querySelector('tr.subtotal-row');
        const totalRow = tbody.querySelector('tr.total-row');
        if (subtotalRow && totalRow) {
          subtotalRow.querySelector('td:last-child p').textContent = `S/ ${subtotal.toFixed(2)}`;
          totalRow.querySelector('td:last-child p').textContent = `S/ ${(subtotal + costoEnvio).toFixed(2)}`;
        }
      };

      // Manejar opciones de envío
      let costoEnvio = 8; // Costo de envío por defecto (recogida local)
      const manejarOpcionesEnvio = () => {
        const checkboxes = document.querySelectorAll('input[name="Envio-1"]');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            checkboxes.forEach(cb => cb.checked = cb === checkbox);
            costoEnvio = checkbox.id === 'Envio-1' ? 0 : checkbox.id === 'Envio-2' ? 15 : 8;
            const subtotal = parseFloat(
              document.querySelector('#cart-items tr.subtotal-row td:last-child p')
                .textContent.replace('S/ ', '')
            );
            actualizarTotales(subtotal, costoEnvio);
          });
        });
      };

      // Cargar productos del carrito
      const cargarCarrito = async () => {
        try {
          const response = await fetch(`http://localhost/minemarket/api/obtener_carrito.php?usuario_id=${usuario_id}`);
          if (!response.ok) throw new Error('Error en la respuesta de la API');
          const productos = await response.json();

          const tbody = document.getElementById('cart-items');
          tbody.innerHTML = '';

          if (!productos.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">El carrito está vacío o contiene productos no disponibles.</td></tr>';
            return;
          }

          let subtotal = 0;
          productos.forEach(item => {
            const total = item.precio * item.cantidad;
            subtotal += total;
            const row = document.createElement('tr');
            row.innerHTML = `
              <th scope="row">
                <div class="d-flex align-items-center mt-2">
                  <img src="${item.imagen_url}" class="img-fluid rounded-circle" style="width: 90px; height: 90px;" alt="${item.nombre}">
                </div>
              </th>
              <td class="py-5">${item.nombre}</td>
              <td class="py-5">S/ ${parseFloat(item.precio).toFixed(2)}</td>
              <td class="py-5">${item.cantidad}</td>
              <td class="py-5">S/ ${total.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
          });

          // Agregar filas de subtotal, envío y total
          tbody.innerHTML += `
            <tr class="subtotal-row">
              <th scope="row"></th>
              <td class="py-5"></td>
              <td class="py-5"></td>
              <td class="py-5"><p class="mb-0 text-dark py-3">Subtotal</p></td>
              <td class="py-5"><div class="py-3 border-bottom border-top"><p class="mb-0 text-dark">S/ ${subtotal.toFixed(2)}</p></div></td>
            </tr>
            <tr>
              <th scope="row"></th>
              <td class="py-5"><p class="mb-0 text-dark py-4">Envío</p></td>
              <td colspan="3" class="py-5">
                <div class="form-check text-start">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Envio-1" name="Envio-1" value="Envío gratis">
                  <label class="form-check-label" for="Envio-1">Envío gratis</label>
                </div>
                <div class="form-check text-start">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Envio-2" name="Envio-1" value="Tarifa fija: S/ 15.00">
                  <label class="form-check-label" for="Envio-2">Tarifa fija: S/ 15.00</label>
                </div>
                <div class="form-check text-start">
                  <input type="radio" class="form-check-input bg-primary border-0" id="Envio-3" name="Envio-1" value="Recogida local: S/ 8.00" checked>
                  <label class="form-check-label" for="Envio-3">Recogida local: S/ 8.00</label>
                </div>
              </td>
            </tr>
            <tr class="total-row">
              <th scope="row"></th>
              <td class="py-5"><p class="mb-0 text-dark text-uppercase py-3">TOTAL</p></td>
              <td class="py-5"></td>
              <td class="py-5"></td>
              <td class="py-5"><div class="py-3 border-bottom border-top"><p class="mb-0 text-dark">S/ ${(subtotal + costoEnvio).toFixed(2)}</p></div></td>
            </tr>
          `;

          actualizarContadorCarrito(productos.reduce((sum, item) => sum + item.cantidad, 0));
          manejarOpcionesEnvio();
        } catch (error) {
          console.error('Error al cargar el carrito:', error);
          document.getElementById('cart-items').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar el carrito</td></tr>';
        }
      };

      // Manejar envío del formulario
      document.getElementById('checkout-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validar campos
        const requiredFields = ['nombre', 'apellidos', 'pais', 'direccion', 'ciudad', 'codigo_postal', 'telefono', 'email'];
        let isValid = true;
        requiredFields.forEach(field => {
          const input = document.getElementById(field);
          if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
          } else {
            input.classList.remove('is-invalid');
          }
        });

        const paymentMethod = document.querySelector('input[name="payment"]:checked');
        const shippingMethod = document.querySelector('input[name="Envio-1"]:checked');
        if (!paymentMethod) {
          alert('Por favor, selecciona un método de pago.');
          isValid = false;
        }
        if (!shippingMethod) {
          alert('Por favor, selecciona un método de envío.');
          isValid = false;
        }

        if (!isValid) return;

        // Recolectar datos
        const orderData = {
          usuario_id: parseInt(usuario_id),
          nombre: document.getElementById('nombre').value.trim(),
          apellidos: document.getElementById('apellidos').value.trim(),
          empresa: document.getElementById('empresa').value.trim() || null,
          pais: document.getElementById('pais').value.trim(),
          direccion: document.getElementById('direccion').value.trim(),
          ciudad: document.getElementById('ciudad').value.trim(),
          codigo_postal: document.getElementById('codigo_postal').value.trim(),
          telefono: document.getElementById('telefono').value.trim(),
          email: document.getElementById('email').value.trim(),
          metodo_pago: paymentMethod.value,
          metodo_envio: shippingMethod.value,
          costo_envio: costoEnvio,
          notas: document.getElementById('notas').value.trim() || null,
          subtotal: parseFloat(document.querySelector('#cart-items tr.subtotal-row td:last-child p').textContent.replace('S/ ', '')),
          total: parseFloat(document.querySelector('#cart-items tr.total-row td:last-child p').textContent.replace('S/ ', ''))
        };

        try {
          // Obtener productos del carrito
          const cartResponse = await fetch(`http://localhost/minemarket/api/obtener_carrito.php?usuario_id=${usuario_id}`);
          const productos = await cartResponse.json();

          // Validar si hay productos disponibles
          if (!productos || productos.length === 0) {
            alert('Tu carrito está vacío o contiene productos no disponibles. Por favor, revisa tu carrito.');
            return;
          }

          // Mapear los productos correctamente
          orderData.items = productos.map(item => ({
            producto_id: item.producto_id, // Usar producto_id en lugar de item.id
            nombre: item.nombre,
            precio: parseFloat(item.precio),
            cantidad: item.cantidad,
            subtotal: parseFloat(item.precio) * item.cantidad
          }));

          // Depuración: Registrar los datos enviados
          console.log("Datos enviados a realizar_pedido.php:", JSON.stringify(orderData, null, 2));

          // Enviar pedido
          const response = await fetch('http://localhost/minemarket/api/realizar_pedido.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
          });
          const data = await response.json();

          if (data.success) {
            alert('¡Pedido realizado con éxito! Gracias por tu compra.');
            await actualizarContadorCarrito();
            window.location.href = 'historial.html';
          } else {
            alert(`Error al realizar el pedido: ${data.error || 'Ocurrió un problema al procesar tu pedido. Por favor, intenta de nuevo.'}`);
          }
        } catch (error) {
          console.error('Error al procesar el pedido:', error);
          alert('Error al procesar el pedido. Por favor, revisa tu conexión e intenta de nuevo.');
        }
      });

      // Inicializar
      cargarCarrito();
    });
  </script>
</body>
</html>
